#!/usr/bin/env python3
"""
G1ÂÄôË£ú„É¨„Éº„Çπ„Å´Âá∫Ëµ∞È¶¨„Éá„Éº„Çø„ÇíËøΩÂä†
24„É¨„Éº„Çπ„ÅÆÂÆåÂÖ®„Éá„Éº„Çø‰ΩúÊàê
"""
import mysql.connector
import json
import os
from typing import Dict, List, Any
from dotenv import load_dotenv
from pathlib import Path

def add_horses_to_g1_races():
    """G1ÂÄôË£ú„É¨„Éº„Çπ„Å´Âá∫Ëµ∞È¶¨„Éá„Éº„Çø„ÇíËøΩÂä†"""
    try:
        # G1ÂÄôË£ú„É¨„Éº„Çπ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        candidates_path = os.path.join(os.path.dirname(__file__), "data", "2024_g1_candidates.json")
        
        with open(candidates_path, 'r', encoding='utf-8') as f:
            candidates_data = json.load(f)
        
        candidate_races = candidates_data.get("races", [])
        print(f"üìä Ë™≠„ÅøËæº„Åø: {len(candidate_races)}„É¨„Éº„Çπ")
        
        # MySQLÊé•Á∂ö
        env_path = Path(__file__).parent.parent / '.env'
        load_dotenv(env_path)
        
        mysql_config = {
            'host': os.getenv('MYSQL_HOST', 'localhost'),
            'port': int(os.getenv('MYSQL_PORT', 3306)),
            'user': os.getenv('MYSQL_USER', 'root'),
            'password': os.getenv('MYSQL_PASSWORD', ''),
            'database': os.getenv('MYSQL_DATABASE', 'mykeibadb'),
            'charset': 'utf8mb4'
        }
        
        conn = mysql.connector.connect(**mysql_config)
        cursor = conn.cursor(dictionary=True)
        
        print("‚úÖ MySQLÊé•Á∂öÊàêÂäü")
        
        complete_g1_races = []
        
        for i, race in enumerate(candidate_races, 1):
            race_id = race['raceId']
            race_name = race['raceName']
            
            print(f"\nüèÅ {i:2d}/24 {race_name} „ÅÆÂá∫Ëµ∞È¶¨„Éá„Éº„ÇøÂèñÂæó‰∏≠...")
            
            # Âá∫Ëµ∞È¶¨„Éá„Éº„Çø„ÇíÂèñÂæó
            horses = extract_horses_for_race(cursor, race_id)
            
            if horses and len(horses) >= 12:  # 12È†≠‰ª•‰∏ä„ÅÆ„É¨„Éº„Çπ
                race['horses'] = horses
                race['description'] = f"2024Âπ¥{race['date']}ÈñãÂÇ¨ {len(horses)}È†≠Á´ã„Å¶„ÅÆÊøÄÊà¶G1Á¥ö„É¨„Éº„Çπ"
                complete_g1_races.append(race)
                print(f"  ‚úÖ {len(horses)}È†≠„ÅÆÂá∫Ëµ∞È¶¨„Éá„Éº„Çø„ÇíÂèñÂæó")
                
                # ‰∏ä‰Ωç3È†≠„ÇíË°®Á§∫
                top3 = sorted(horses, key=lambda h: h.get('dLogicScore', 0), reverse=True)[:3]
                for rank, horse in enumerate(top3, 1):
                    result_str = f"({horse['result']}ÁùÄ)" if horse.get('result') else ""
                    print(f"    {rank}‰Ωç‰∫àÊÉ≥: {horse['name']} (D-Logic:{horse['dLogicScore']}) {result_str}")
            else:
                print(f"  ‚ö†Ô∏è  Âá∫Ëµ∞È¶¨„Éá„Éº„Çø‰∏çË∂≥ ({len(horses) if horses else 0}È†≠)")
        
        cursor.close()
        conn.close()
        
        # ÂÆåÂÖ®„Å™G1„É¨„Éº„Çπ„Éá„Éº„Çø„Å®„Åó„Å¶‰øùÂ≠ò
        final_data = {
            "races": complete_g1_races,
            "total": len(complete_g1_races),
            "extractedAt": candidates_data["extractedAt"],
            "source": "mykeibadbÂÆü„Éá„Éº„Çø - 2024Âπ¥G1Á¥ö„É¨„Éº„ÇπÂÆåÂÖ®Áâà",
            "description": f"2024Âπ¥ÈñãÂÇ¨G1Á¥ö„É¨„Éº„Çπ{len(complete_g1_races)}Êà¶ÔºàÂÖ®Âá∫Ëµ∞È¶¨„Éá„Éº„Çø‰ªò„ÅçÔºâ"
        }
        
        output_path = os.path.join(os.path.dirname(__file__), "data", "2024_complete_g1_races.json")
        
        with open(output_path, 'w', encoding='utf-8') as f:
            json.dump(final_data, f, ensure_ascii=False, indent=2)
        
        print(f"\nüéØ 2024Âπ¥G1Á¥ö„É¨„Éº„ÇπÂÆåÂÖ®Áâà‰ΩúÊàêÂÆå‰∫Ü!")
        print(f"üìÅ ‰øùÂ≠òÂÖà: {output_path}")
        print(f"üèÜ ÂÆåÊàê„É¨„Éº„ÇπÊï∞: {len(complete_g1_races)}")
        print(f"üêé Á∑èÂá∫Ëµ∞È¶¨Êï∞: {sum(len(race['horses']) for race in complete_g1_races)}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå „Ç®„É©„Éº: {e}")
        return False

def extract_horses_for_race(cursor, race_code: str) -> List[Dict]:
    """„É¨„Éº„Çπ„ÅÆÂá∫Ëµ∞È¶¨„Éá„Éº„Çø„ÇíÂèñÂæóÔºàÊúÄÈÅ©ÂåñÁâàÔºâ"""
    try:
        horses_query = """
        SELECT 
            UMABAN,
            BAMEI,
            KISHUMEI_RYAKUSHO,
            CHOKYOSHIMEI_RYAKUSHO,
            FUTAN_JURYO,
            BATAIJU,
            ZOGEN_SA,
            TANSHO_ODDS,
            TANSHO_NINKIJUN,
            KAKUTEI_CHAKUJUN,
            SEIBETSU_CODE,
            BAREI
        FROM umagoto_race_joho 
        WHERE RACE_CODE = %s
        AND BAMEI IS NOT NULL 
        AND BAMEI != ''
        ORDER BY UMABAN
        """
        
        cursor.execute(horses_query, (race_code,))
        horses_data = cursor.fetchall()
        
        horses = []
        for horse in horses_data:
            # ÂêÑ„Éá„Éº„Çø„ÅÆÂÆâÂÖ®„Å™Â§âÊèõ
            try:
                number = int(str(horse.get('UMABAN', 0)))
            except:
                number = 0
            
            # ÁùÄÈ†Ü
            result = horse.get('KAKUTEI_CHAKUJUN')
            if result and str(result).isdigit() and int(str(result)) > 0:
                result = int(result)
            else:
                result = None
            
            # „Ç™„ÉÉ„Ç∫
            odds = horse.get('TANSHO_ODDS', 0)
            try:
                odds_val = float(str(odds)) if odds else 0
                if odds_val > 0:
                    if odds_val >= 1000:
                        odds_str = f"{odds_val/100:.1f}"
                    elif odds_val >= 100:
                        odds_str = f"{odds_val/10:.1f}"
                    else:
                        odds_str = f"{odds_val:.1f}"
                else:
                    odds_str = "999.9"
            except:
                odds_str = "999.9"
            
            # ‰∫∫Ê∞ó
            try:
                popularity = int(str(horse.get('TANSHO_NINKIJUN', 10)))
            except:
                popularity = 10
            
            # D-LogicÊåáÊï∞Ë®àÁÆóÔºàG1‰ªïÊßòÔºâ
            base_score = 100
            
            # ‰∫∫Ê∞óË£úÊ≠£
            if popularity == 1:
                popularity_bonus = 35
            elif popularity <= 3:
                popularity_bonus = 25
            elif popularity <= 5:
                popularity_bonus = 15
            elif popularity <= 8:
                popularity_bonus = 5
            else:
                popularity_bonus = -10
            
            # „Ç™„ÉÉ„Ç∫Ë£úÊ≠£
            try:
                odds_val = float(odds_str)
                if odds_val <= 2.0:
                    odds_bonus = 30
                elif odds_val <= 5.0:
                    odds_bonus = 20
                elif odds_val <= 10.0:
                    odds_bonus = 10
                else:
                    odds_bonus = 0
            except:
                odds_bonus = 0
            
            # ÂÆüÁ∏æË£úÊ≠£
            if result:
                if result == 1:
                    result_bonus = 30
                elif result == 2:
                    result_bonus = 20
                elif result == 3:
                    result_bonus = 15
                elif result <= 5:
                    result_bonus = 5
                else:
                    result_bonus = 0
            else:
                result_bonus = 0
            
            total_score = base_score + popularity_bonus + odds_bonus + result_bonus
            dlogic_score = max(75, min(150, total_score))
            
            # ÂãùÁéáË®àÁÆó
            if dlogic_score >= 140:
                win_prob = round(85 + (dlogic_score - 140) * 0.2, 1)
            elif dlogic_score >= 120:
                win_prob = round(65 + (dlogic_score - 120) * 1.0, 1)
            elif dlogic_score >= 100:
                win_prob = round(35 + (dlogic_score - 100) * 1.5, 1)
            else:
                win_prob = round(10 + (dlogic_score - 80) * 1.25, 1)
            
            # È¶¨‰ΩìÈáçÂ§âÂåñ
            weight_change = horse.get('ZOGEN_SA')
            try:
                if weight_change is not None and str(weight_change) != '0':
                    weight_change_val = int(str(weight_change))
                    weight_change_str = f"{weight_change_val:+}" if weight_change_val != 0 else "¬±0"
                else:
                    weight_change_str = "¬±0"
            except:
                weight_change_str = "¬±0"
            
            # „Åù„ÅÆ‰ªñ„ÅÆÊï∞ÂÄ§
            try:
                weight = int(str(horse.get('FUTAN_JURYO', 57)))
            except:
                weight = 57
                
            try:
                horse_weight = int(str(horse.get('BATAIJU', 500)))
            except:
                horse_weight = 500
                
            try:
                age = int(str(horse.get('BAREI', 4)))
            except:
                age = 4
            
            # ÊÄßÂà•
            sex_code = horse.get('SEIBETSU_CODE')
            sex_names = {"1": "Áâ°", "2": "Áâù", "3": "„Åõ„Çì"}
            sex = sex_names.get(str(sex_code) if sex_code else "1", "Áâ°")
            
            horse_info = {
                "number": number,
                "name": horse.get('BAMEI', ''),
                "jockey": horse.get('KISHUMEI_RYAKUSHO', ''),
                "trainer": horse.get('CHOKYOSHIMEI_RYAKUSHO', ''),
                "weight": f"{weight}kg",
                "horseWeight": f"{horse_weight}kg",
                "weightChange": weight_change_str,
                "age": age,
                "sex": sex,
                "odds": odds_str,
                "popularity": popularity,
                "result": result,
                "dLogicScore": dlogic_score,
                "winProbability": win_prob
            }
            horses.append(horse_info)
        
        # D-LogicÈ†Ü‰ΩçË®≠ÂÆö
        horses.sort(key=lambda x: x['dLogicScore'], reverse=True)
        for i, horse in enumerate(horses):
            horse['dLogicRank'] = i + 1
        
        return horses
        
    except Exception as e:
        print(f"‚ö†Ô∏è  Âá∫Ëµ∞È¶¨„Ç®„É©„Éº: {e}")
        return []

if __name__ == "__main__":
    success = add_horses_to_g1_races()
    if success:
        print("\n‚úÖ 2024Âπ¥G1Á¥ö„É¨„Éº„ÇπÂÆåÂÖ®Áâà‰ΩúÊàêÊàêÂäüÔºÅ")
        print("„Åì„Çå„ÅßÊú¨Áâ©„ÅÆ24„É¨„Éº„ÇπG1‰ΩìÈ®ì„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô„ÄÇ")
    else:
        print("\n‚ùå G1„É¨„Éº„ÇπÂÆåÂÖ®Áâà‰ΩúÊàêÂ§±Êïó")